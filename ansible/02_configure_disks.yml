---

- hosts: all
  tasks:
    - name: Add an Apt signing key, uses whichever key is at the URL
      apt_key:
        url: https://nvidia.github.io/libnvidia-container/gpgkey
        state: present
        keyring: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    - name: Add specified repository into sources list using specified filename
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/stable/deb/$(ARCH)"
        state: present
        filename: nvidia-container-toolkit
    - name: Only run "update_cache=yes" if the last one is more than 3600 seconds ago
      apt:
        name: nvidia-container-toolkit=1.14.2
        state: present
        update_cache: yes
        cache_valid_time: 3600
    - name: create partition for local cache
      parted:
        device: "{{ local_cache_disk.device }}"
        number: "{{ local_cache_disk.number | default(1) }}"
        flags: [ lvm ]
        state: present
        part_end: "{{ local_cache_disk.part_end }}"
      register: local_cache_partition
    - name: create partitions for distributed cache
      parted:
        device: "{{ item.device }}"
        number: "{{ item.number }}"
        flags: [ lvm ]
        state: present
        part_start: "{{ item.part_start | default('0%')}}"
        part_end: "{{ item.part_end | default('100%')}}"
      loop: "{{ distributed_cache_disks }}"
      register: distributed_cache_partitions
    - name: merge distributed cache partitions into a single list SSD 
      set_fact:
        distrib_partitions_list: |-
          [
          {% for partition in distributed_cache_partitions.results %}
            "{{ partition.item.device}}{{ partition.item.number }}",
          {% endfor %}
          ]
      when: '"/dev/sd" in local_cache_disk.device'
    - name: merge distributed cache partitions into a single list NVME 
      set_fact:
        distrib_partitions_list: |-
          [
          {% for partition in distributed_cache_partitions.results %}
            "{{ partition.item.device}}p{{ partition.item.number }}",
          {% endfor %}
          ]
      when: '"nvme" in local_cache_disk.device'
    - name: Display local cache partitions
      debug:
        var: local_cache_partition
    - name: Display distributed cache partitions
      debug:
        var: distrib_partitions_list
    - name: create volume group for local cache SSD
      lvg:
        vg: csi-lvm-local-cache
        pvs: "{{ local_cache_partition.disk.dev }}{{ local_cache_partition.partitions[0].num }}"
      when: '"/dev/sd" in local_cache_disk.device'
    - name: create volume group for local cache NVME
      lvg:
        vg: csi-lvm-local-cache
        pvs: "{{ local_cache_partition.disk.dev }}p{{ local_cache_partition.partitions[0].num }}"
      when: '"nvme" in local_cache_disk.device'
    - name: create volume group for distributed cache
      lvg:
        vg: csi-lvm-distributed-cache
        pvs: "{{ distrib_partitions_list }}"
        state: present
    - name: Install lvm2 dependency
      package:
        name: lvm2
        state: present